<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visual Debugger</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@ffmpeg/ffmpeg@0.9.3/dist/ffmpeg.min.js"></script>
    <style type="text/css">
      html,
      body,
      #visjs-network {
        width: 100%;
        height: 100%;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="visjs-network"></div>
    <script type="text/javascript">
      let network;
      let edges;
      let nodes;
      let defaultNodeColor;
      let defaultEdgeColor;
      let recorder;
      let chunks;
      window.addEventListener('message', (event) => {
        const message = event.data;
        if (message.command === 'initializeVisjs') {
          const container = document.querySelector('#visjs-network');
          edges = new vis.DataSet(message.data.edges);
          nodes = new vis.DataSet(message.data.nodes);
          defaultNodeColor = message.options.nodes.color;
          defaultEdgeColor = message.options.edges.color;
          const data = {
            edges,
            nodes
          };
          network = new vis.Network(container, data, message.options);
        } else if (message.command === 'updateVisjs') {
          edges.remove(message.data.deleteEdgeIds);
          nodes.remove(message.data.deleteNodeIds);
          nodes.updateOnly(nodes.map((node) => ({
            ...node,
            color: defaultNodeColor
          })));
          edges.updateOnly(edges.map((edge) => ({
            ...edge,
            color: defaultEdgeColor
          })));
          nodes.add(message.data.addNodes);
          nodes.updateOnly(message.data.updateNodes);
          edges.add(message.data.addEdges);
        } else if (message.command === 'exportVisjs') {
          const canvas = document.querySelector('#visjs-network canvas');
          const img = canvas.toDataURL('image/png');
          downloadFile('export.png', img);
        } else if (message.command === 'startRecordingVisjs') {
          chunks = [];
          const canvas = document.querySelector('#visjs-network canvas');
          const stream = canvas.captureStream();
          recorder = new MediaRecorder(stream, {
            mimeType: 'video/webm;codecs=vp9',
            ignoreMutedMedia: true
          });
          recorder.ondataavailable = e => {
            if (e.data.size > 0) {
              chunks.push(e.data);
            }
          };
          recorder.start()
        } else if (message.command === 'stopRecordingVisjs') {
          recorder.stop();
          sendInfoMessage('Creating GIF. This may take some time.');
          setTimeout(() => {
            const blob = new Blob(chunks, {
              type: "video/webm"
            });
            const webmVideo = URL.createObjectURL(blob);
            convertWebmToGif(webmVideo);
          }, 0);
        }
      });

      function sendInfoMessage(message) {
        const vscode = acquireVsCodeApi();
        vscode.postMessage({
          command: 'info',
          text: message
        })
      }

      function convertWebmToGif(file) {
        const {
          createFFmpeg,
          fetchFile
        } = FFmpeg;
        const ffmpeg = createFFmpeg({
          corePath: "https://unpkg.com/@ffmpeg/core@0.10.0/dist/ffmpeg-core.js",
          log: true
        });
        (async () => {
          await ffmpeg.load();
          ffmpeg.FS('writeFile', 'export.webm', await fetchFile(file));
          await ffmpeg.run('-i', 'export.webm', 'export.gif');
          const data = ffmpeg.FS('readFile', 'export.gif');
          var gifVideo = URL.createObjectURL(new Blob([data.buffer], {
            type: 'image/gif'
          }));
          downloadFile('export.gif', gifVideo);
          process.exit(0);
        })();
      }

      function downloadFile(filename, file) {
        var downloadLink = document.createElement('a');
        downloadLink.download = filename;
        downloadLink.href = file;
        downloadLink.click();
      }
    </script>
  </body>
</html>